{% extends "base.html" %}
{% block content %}

    <!--display errors if any-->
    {% if form.errors %}
        <p>sorry sbout that...</p>
    {% endif %}

    <!--login form, username and password-->
    <form action="/accounts/auth/" method="post">
        {% csrf_token %}
        <label for="username">User name:</label>
        <input type="text" name="username" value="" id="username">
        <label for="password">Password:</label>
        <input type="password" name="password" value="" id="password">
        <input type="submit" value="login"/>
    </form>
    <br>
    <br>
    <a href="{% url "social:begin" "google-oauth2" %}">Google+</a>
    <br>
    <a href="{% url 'social:begin' 'vk-oauth2' %}?next={% url 'main:index' %}">VK</a>

    <br>
    <script src="http://vk.com/js/api/xd_connection.js?2" type="text/javascript"></script>
    <script type="text/javascript">
        VK.init(function () {
                VK.addCallback("onApplicationAdded", requestRights);
                VK.addCallback("onSettingsChanged", onSettingsChanged);
            }
        );

        function startConnect() {
            VK.callMethod('showInstallBox');
        }

        function requestRights() {
            VK.callMethod('showSettingsBox', 1 + 2); // 1+2 is just an example
        }

        function onSettingsChanged(settings) {
            window.location.reload();
        }
    </script>
    <a href="#" onclick="startConnect(); return false;">Click to authenticate</a>
    <br>
    <br>
    <br>
    <a href="/login/vk-oauth2"><img src="lvk.png" class="avatar-3" data-toggle="tooltip"
                                    title="dsadas"></a>

    <br>
    <div id="google-plus-button">Google+ Sign In</div>

    <script src="https://apis.google.com/js/api:client.js"></script>

    <script type="text/javascript">
        gapi.load('auth2', function () {
            var auth2;

            auth2 = gapi.auth2.init({
                client_id: "booktobook",
                scope: "email"
            });

            auth2.then(function () {
                var button = document.getElementById("google-plus-button");
                console.log("User is signed-in in Google+ platform?", auth2.isSignedIn.get() ? "Yes" : "No");

                auth2.attachClickHandler(button, {}, function (googleUser) {
                    // Send access-token to backend to finish the authenticate
                    // with your application

                    var authResponse = googleUser.getAuthResponse();
                    var $form;
                    var $input;

                    $form = $("<form>");
                    $form.attr("action", "/complete/google-plus");
                    $form.attr("method", "post");
                    $input = $("<input>");
                    $input.attr("name", "id_token");
                    $input.attr("value", authResponse.id_token);
                    $form.append($input);
                    // Add csrf-token if needed
                    $(document.body).append($form);
                    $form.submit();
                });
            });
        });
    </script>
    <br>
    <br>
    <script src="http://vk.com/js/api/openapi.js" type="text/javascript"></script>
<script type="text/javascript">
    var vkAppId = {{ settings.VK_APP_ID | default:"null" }};
    if (vkAppId) {
        VK.init({ apiId: vkAppId });
    }
    function authVK () {
        if (!vkAppId) {
            alert ("Please specify VK.com APP ID in your local settings file");
            return false;
        }
        VK.Auth.login(function(response) {
            var params = "";
            if (response.session) {
                params = "first_name=" + encodeURI(response.session.user.first_name) + "&last_name=" + encodeURI(response.session.user.last_name);
                params += "&nickname=" + encodeURI(response.session.user.nickname) + "&id=" + encodeURI(response.session.user.id);
            }
            window.location = "{{ VK_COMPLETE_URL }}?" + params;
        });
        return false;
    }
</script>
<a href="javascript:void(0);" onclick="authVK();">Click to authorize vi VK....</a>
{% endblock %}

